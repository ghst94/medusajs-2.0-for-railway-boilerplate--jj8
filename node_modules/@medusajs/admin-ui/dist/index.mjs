var ge=Object.defineProperty;var a=(e,t)=>ge(e,"name",{value:t,configurable:!0}),$=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,i)=>(typeof require<"u"?require:t)[i]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+e+'" is not supported')});var L=["/products","/products/:id","/product-categories","/product-categories","/orders","/orders/:id","/customers","/customers/:id","/customers/groups","/customers/groups/:id","/discounts","/discounts/new","/discounts/:id","/gift-cards","/gift-cards/:id","/gift-cards/manage","/pricing","/pricing/new","/pricing/:id","/inventory","/collections","/collections/:id","/draft-orders","/draft-orders/:id","/login","/sales-channels","/publishable-api-keys","/oauth","/oauth/:app_name"];var R=["order.details.before","order.details.after","order.list.before","order.list.after","draft_order.list.before","draft_order.list.after","draft_order.details.before","draft_order.details.after","customer.details.before","customer.details.after","customer.list.before","customer.list.after","customer_group.details.before","customer_group.details.after","customer_group.list.before","customer_group.list.after","product.details.before","product.details.after","product.list.before","product.list.after","product_collection.details.before","product_collection.details.after","product_collection.list.before","product_collection.list.after","price_list.details.before","price_list.details.after","price_list.list.before","price_list.list.after","discount.details.before","discount.details.after","discount.list.before","discount.list.after","gift_card.details.before","gift_card.details.after","gift_card.list.before","gift_card.list.after","custom_gift_card.before","custom_gift_card.after","login.before","login.after"];import B from"node:path";import Ge from"webpack";import _e from"fs-extra";import M from"node:path";import X from"fs-extra";function j(e){return!(X.lstatSync(e).isDirectory()&&e.includes("__test__")||X.lstatSync(e).isFile()&&(e.includes(".test")||e.includes(".spec")||e.includes("webpack.config")))}a(j,"copyFilter");import w from"fs-extra";import m from"node:path";import I from"ts-dedent";import x from"picocolors";import Z from"readline";var T="[@medusajs/admin]";function he(){let e=process.stdout.rows-2,t=e>0?`
`.repeat(e):"";console.log(t),Z.cursorTo(process.stdout,0,0),Z.clearScreenDown(process.stdout)}a(he,"clearScreen");var ye=process.stdout.isTTY&&!process.env.CI,ve=ye?he:()=>{};function xe(){let e=a((t,i,r)=>{let o=t==="info"?"log":t,n=a(()=>{let s=t==="info"?x.cyan(x.bold(T)):t==="warn"?x.yellow(x.bold(T)):x.red(x.bold(T));return`${x.dim(new Date().toLocaleTimeString())} ${s} ${i}`},"format");r!=null&&r.clearScreen&&ve(),console[o](n())},"output");return{info:(t,i)=>e("info",t,i),warn:(t,i)=>e("warn",t,i),error:(t,i)=>e("error",t,i),panic:(t,i)=>{e("error",t,i),process.exit(1)}}}a(xe,"createLogger");var l=xe();function v(e){let i=process.platform==="win32"?"\\":"/",r=new RegExp(`\\${i}`,"g");return e.replace(r,"/")}a(v,"normalizePath");import{parse as N}from"@babel/parser";import k from"@babel/traverse";import h from"fs-extra";import _ from"path";function H(e){return R.includes(e)}a(H,"isValidInjectionZone");function we(e){let t=e.find(r=>r.type==="ObjectProperty"&&r.key.type==="Identifier"&&r.key.name==="zone");if(!t)return!1;let i=!1;return t.value.type==="StringLiteral"?i=H(t.value.value):t.value.type==="ArrayExpression"&&(i=t.value.elements.every(r=>r.type==="StringLiteral"&&H(r.value))),i}a(we,"validateWidgetConfigExport");function be(e){let t=e.find(o=>o.type==="ObjectProperty"&&o.key.type==="Identifier"&&o.key.name==="link");if(!t)return!0;let i=t.value,r=!1;return i.properties.some(o=>o.type==="ObjectProperty"&&o.key.type==="Identifier"&&o.key.name==="label"&&o.value.type==="StringLiteral")&&(r=!0),r}a(be,"validateRouteConfigExport");function Ee(e){let t=e.find(n=>n.type==="ObjectProperty"&&n.key.type==="Identifier"&&n.key.name==="card");if(!t)return!1;let i=t.value,r=!1,o=!1;return i.properties.some(n=>n.type==="ObjectProperty"&&n.key.type==="Identifier"&&n.key.name==="label"&&n.value.type==="StringLiteral")&&(r=!0),i.properties.some(n=>n.type==="ObjectProperty"&&n.key.type==="Identifier"&&n.key.name==="description"&&n.value.type==="StringLiteral")&&(o=!0),r&&o}a(Ee,"validateSettingConfigExport");function O(e,t){let i=!1,r=e.node.declaration;if(r&&r.type==="VariableDeclaration"){let o=r.declarations.find(n=>n.type==="VariableDeclarator"&&n.id.type==="Identifier"&&n.id.name==="config");if(o&&o.init.type==="ObjectExpression"){let n=o.init.properties;t==="widget"&&(i=we(n)),t==="route"&&(i=be(n)),t==="setting"&&(i=Ee(n))}else i=!1}return i}a(O,"validateConfigExport");function z(e,t){let i=!1,r=e.node.declaration;if(r&&(r.type==="Identifier"||r.type==="FunctionDeclaration")){let o=r.type==="Identifier"?r.name:r.id&&r.id.name;o&&k(t,{VariableDeclarator({node:n,scope:s}){let c=!1;n.id.type==="Identifier"&&n.id.name===o&&(c=!0),c&&k(n,{ReturnStatement(p){var d,f;(((d=p.node.argument)==null?void 0:d.type)==="JSXElement"||((f=p.node.argument)==null?void 0:f.type)==="JSXFragment")&&(i=!0)}},s)}})}return i}a(z,"validateDefaultExport");async function Q(e){let t=await h.readFile(e,"utf-8"),i={sourceType:"module",plugins:["jsx"]};(e.endsWith(".ts")||e.endsWith(".tsx"))&&i.plugins.push("typescript");let r;try{r=N(t,i)}catch{return l.error(`The widget ${e} is invalid and will not be injected. Please make sure that the widget is valid.`),!1}let o=!1,n=!1;return k(r,{ExportDefaultDeclaration:s=>{n=z(s,r)},ExportNamedDeclaration:s=>{o=O(s,"widget")}}),o&&!n&&(n||l.error(`The default export in ${e} is invalid and the widget will not be injected. Please make sure that the default export is a valid React component.`)),!o&&n&&l.error(`The widget config export in ${e} is invalid and the widget will not be injected. Please make sure that the config export is valid.`),o&&n}a(Q,"validateWidget");function Y(e){let t=v(e),i=/\[(.*?)\]/g;return t.replace(i,":$1").replace(/\/page\.[jt]sx?$/i,"")}a(Y,"createPath");function $e(e){return L.includes(e)}a($e,"isForbiddenRoute");function ee(e,t){if($e(e))return{error:`A route from ${t} is using a forbidden path: ${e}.`,valid:!1};let i=["/",":","-"];for(let r=0;r<e.length;r++){let o=e[r];if(!i.includes(o)&&!/^[a-z0-9]$/i.test(o))return{error:`A route from ${t} is using an invalid path: ${e}. Only alphanumeric characters, "/", ":", and "-" are allowed.`,valid:!1};if(o===":"&&(r===0||e[r-1]!=="/"))return{error:`A route from ${t} is using an invalid path: ${e}. All dynamic segments must be preceded by a "/".`,valid:!1}}return{valid:!0,error:""}}a(ee,"validatePath");async function te(e,t){let i=Y(e.replace(t,"")),{valid:r,error:o}=ee(i,e);if(!r)return l.error(`The page ${e} is invalid and will not be injected. ${o}`),null;let n=await h.readFile(e,"utf-8"),s=!1,c=!1,p={sourceType:"module",plugins:["jsx"]};(e.endsWith(".ts")||e.endsWith(".tsx"))&&p.plugins.push("typescript");let d=N(n,p);return k(d,{ExportDefaultDeclaration:f=>{s=z(f,d)},ExportNamedDeclaration:f=>{c=O(f,"route")}}),s?{path:i,hasConfig:c,file:e}:(l.error(`The default export in ${e} is invalid and the page will not be injected. Please make sure that the default export is a valid React component.`),null)}a(te,"validateRoute");async function re(e,t){let i=Y(e.replace(t,"")),{valid:r,error:o}=ee(i,e);if(!r)return l.error(`The settings page ${e} is invalid and will not be injected. ${o}`),null;let n=await h.readFile(e,"utf-8"),s=!1,c=!1,p={sourceType:"module",plugins:["jsx"]};(e.endsWith(".ts")||e.endsWith(".tsx"))&&p.plugins.push("typescript");let d=N(n,p);return k(d,{ExportDefaultDeclaration:f=>{s=z(f,d)},ExportNamedDeclaration:f=>{c=O(f,"setting")}}),s?c?{path:i,file:e}:(l.error(`The named export "config" in ${e} is invalid or missing and the settings page will not be injected. Please make sure that the file exports a valid config.`),null):(l.error(`The default export in ${e} is invalid and the page will not be injected. Please make sure that the default export is a valid React component.`),null)}a(re,"validateSetting");async function A(e){let t=[];if(!await h.pathExists(e))return[];let r=await h.readdir(e);for(let n of r){let s=_.join(e,n);if((await h.stat(s)).isDirectory()){let p=await h.readdir(s);for(let d of p){let f=_.join(e,n,d);if((await h.stat(f)).isFile()&&/^(.*\/)?page\.[jt]sx?$/i.test(d)){t.push(f);break}}}}return(await Promise.all(t.map(async n=>re(n,e)))).filter(n=>n!==null)}a(A,"findAllValidSettings");async function D(e){let t=[];if(!await h.pathExists(e))return[];async function r(s){let c=await h.readdir(s);for(let p of c){let d=_.join(s,p),f=await h.stat(d);f.isDirectory()?await r(d):f.isFile()&&/\.(js|jsx|ts|tsx)$/i.test(p)&&t.push(d)}}a(r,"traverseDirectory"),await r(e);let o=t.map(s=>Q(s)?s:null);return(await Promise.all(o)).filter(s=>s!==null)}a(D,"findAllValidWidgets");async function F(e){let t=[];if(!await h.pathExists(e))return[];async function r(s){let c=await h.readdir(s);for(let p of c){let d=_.join(s,p),f=await h.stat(d);f.isDirectory()?await r(d):f.isFile()&&/^(.*\/)?page\.[jt]sx?$/i.test(p)&&t.push(d)}}a(r,"traverseDirectory"),await r(e);let o=t.map(async s=>te(s,e));return(await Promise.all(o)).filter(s=>s!==null)}a(F,"findAllValidRoutes");var W=/\.[^/.]+$/;async function ke(e,t){try{await w.copy(e,t,{filter:j})}catch(i){l.panic(`Could not copy local extensions to cache folder. ${i.message}`)}}a(ke,"copyLocalExtensions");async function Ce(e,t){let i=m.resolve(e,"src","admin");if(!await w.pathExists(i))return!1;await ke(i,m.resolve(t,"admin","src","extensions"));let[o,n,s]=await Promise.all([D(m.resolve(t,"admin","src","extensions","widgets")),F(m.resolve(t,"admin","src","extensions","routes")),A(m.resolve(t,"admin","src","extensions","settings"))]),c=o.map((g,u)=>{let y=v(m.relative(m.resolve(t,"admin","src","extensions"),g).replace(W,""));return{importStatement:`import Widget${u}, { config as widgetConfig${u} } from "./${y}"`,extension:`{ Component: Widget${u}, config: { ...widgetConfig${u}, type: "widget" } }`}}),p=n.map((g,u)=>{let y=v(m.relative(m.resolve(t,"admin","src","extensions"),g.file).replace(W,"")),S=g.hasConfig?`import Page${u}, { config as routeConfig${u} } from "./${y}"`:`import Page${u} from "./${y}"`,ue=g.hasConfig?`{ Component: Page${u}, config: { ...routeConfig${u}, type: "route",  path: "${g.path}" } }`:`{ Component: Page${u}, config: { path: "${g.path}", type: "route" } }`;return{importStatement:S,extension:ue}}),d=s.map((g,u)=>{let y=v(m.relative(m.resolve(t,"admin","src","extensions"),g.file).replace(W,""));return{importStatement:`import Setting${u}, { config as settingConfig${u} } from "./${y}"`,extension:`{ Component: Setting${u}, config: { ...settingConfig${u}, path: "${g.path}", type: "setting" } }`}}),f=[...c,...p,...d],E=I`
    ${f.map(g=>g.importStatement).join(`
`)}

    const LocalEntry = {
      identifier: "local",
      extensions: [
        ${f.map(g=>g.extension).join(`,
`)}
      ],
    }

    export default LocalEntry
  `;try{await w.outputFile(m.resolve(t,"admin","src","extensions","_local-entry.ts"),E)}catch(g){l.panic(`Failed to write the entry file for the local extensions. Error: ${g.message}`)}return!0}a(Ce,"createLocalExtensionsEntry");function Pe(e){let t=[];for(let i of e)try{let r=m.dirname($.resolve(`${i}/package.json`,{paths:[process.cwd()]})),o=m.resolve(r,"dist","admin","_virtual_entry.js");w.existsSync(o)&&t.push(o)}catch{l.warn(`There was an error while attempting to load extensions from the plugin: ${i}. Are you sure it is installed?`)}return t}a(Pe,"findPluginsWithExtensions");async function Se(e,t){let i=I`
    const path = require("path")

    const devPath = path.join(__dirname, "..", "..", "src/admin/**/*.{js,jsx,ts,tsx}")

    module.exports = {
      content: [
        devPath,
        ${t.map(r=>`"${v(m.relative(m.resolve(e,"admin"),m.dirname(m.join(r,"..",".."))))}/dist/admin/**/*.{js,jsx,ts,tsx}"`).join(`,
`)}
      ],
    }
  
  `;try{await w.outputFile(m.resolve(e,"admin","tailwind.content.js"),i)}catch{l.warn(`Failed to write the Tailwind content file to ${e}. The admin UI will remain functional, but CSS classes applied to extensions from plugins might not have the correct styles`)}}a(Se,"writeTailwindContentFile");async function je(e,t,i){if(!t.length&&!i){let s=I`
      const extensions = []

      export default extensions
    `;try{await w.outputFile(m.resolve(e,"admin","src","extensions","_main-entry.ts"),s)}catch(c){l.panic(`Failed to write the entry file for the main extensions. Error: ${c.message}`)}return}let o=[...t.map(s=>v(m.relative(m.resolve(e,"admin","src","extensions"),s).replace(W,""))).map((s,c)=>({importStatement:`import Plugin${c} from "${s}"`,extension:`Plugin${c}`})),...i?[{importStatement:'import LocalEntry from "./_local-entry"',extension:"LocalEntry"}]:[]],n=I`
      ${o.map(s=>s.importStatement).join(`
`)}

      const extensions = [
        ${o.map(s=>s.extension).join(`,
`)}
      ]

      export default extensions
    `;try{await w.outputFile(m.resolve(e,"admin","src","extensions","_main-entry.ts"),n)}catch(s){l.panic(`Failed to write the extensions entry file. Error: ${s.message}`)}}a(je,"createMainExtensionsEntry");async function V({appDir:e,dest:t,plugins:i}){let r=await Ce(e,t),o=Pe(i);await je(t,o,r),await Se(t,o)}a(V,"createEntry");async function Ae(e){let t=M.resolve(__dirname,"..","ui"),i=M.resolve(e,"admin");try{await _e.copy(t,i,{filter:j})}catch{l.panic(`Could not copy the admin UI to ${i}. Please make sure you have write access to this folder.`)}}a(Ae,"copyAdmin");async function C({appDir:e,plugins:t}){let i=M.resolve(e,".cache");return await Ae(i),await V({appDir:e,dest:i,plugins:t}),{cacheDir:i}}a(C,"createCacheDir");import ie from"dotenv";import De from"fs-extra";import oe from"node:path";var Fe=/^MEDUSA_ADMIN_/i,b="";switch(process.env.NODE_ENV){case"production":b=".env.production";break;case"staging":b=".env.staging";break;case"test":b=".env.test";break;case"development":default:b=".env";break}De.existsSync(b)?ie.config({path:oe.resolve(process.cwd(),b)}):b!==".env"&&ie.config({path:oe.resolve(process.cwd(),".env")});var U=a(e=>{let t=Object.keys(process.env).filter(r=>Fe.test(r)).reduce((r,o)=>(r[o]=process.env[o],r),{ADMIN_PATH:e.path||"/",NODE_ENV:e.env||"development",MEDUSA_BACKEND_URL:e.backend||process.env.MEDUSA_BACKEND_URL});return{"process.env":Object.keys(t).reduce((r,o)=>(r[o]=JSON.stringify(t[o]),r),{})}},"getClientEnv");import We from"chokidar";import Ie from"node:path";async function G(e,t,i){let r=Ie.resolve(e,"src","admin"),o=We.watch(r,{ignored:/(^|[/\\])\../,ignoreInitial:!0});o.on("all",async()=>{await V({appDir:e,dest:t,plugins:i}),l.info("Extensions cache directory was re-initialized")}),process.on("SIGINT",async()=>{await o.close()}).on("SIGTERM",async()=>{await o.close()})}a(G,"watchLocalAdminFolder");import ze from"fs-extra";import Me from"node:path";import Ue from"webpack";import Ve from"@pmmmwh/react-refresh-webpack-plugin";import Le from"html-webpack-plugin";import J from"mini-css-extract-plugin";import ae from"node:path";import{SwcMinifyWebpackPlugin as Re}from"swc-minify-webpack-plugin";import Te from"webpack";import Ne from"webpackbar";var q=["react","react-dom","react-router-dom","react-dnd","react-dnd-html5-backend","react-select","react-helmet-async","@tanstack/react-query","@tanstack/react-table","@emotion/react","medusa-react"];var ne=q.reduce((e,t)=>(e[`${t}$`]=$.resolve(t),e),{});function Oe(e){return e?e==="/"||e.endsWith("/")?e:`${e}/`:"/app/"}a(Oe,"formatPublicPath");function K({entry:e,dest:t,cacheDir:i,env:r,options:o,template:n,reporting:s="fancy"}){let c=r==="production",p=U({env:r,backend:o==null?void 0:o.backend,path:o==null?void 0:o.path}),d=Oe(o==null?void 0:o.path),f=c?[new J({filename:"[name].[chunkhash].css",chunkFilename:"[name].[chunkhash].css"}),new Ne({basic:s==="minimal",fancy:s==="fancy"})]:[new J];return{mode:r,bail:!!c,devtool:c?!1:"eval-source-map",entry:[e],output:{path:t,filename:c?"[name].[contenthash:8].js":"[name].bundle.js",chunkFilename:c?"[name].[contenthash:8].chunk.js":"[name].chunk.js"},optimization:{minimize:!0,minimizer:[new Re],moduleIds:"deterministic",runtimeChunk:!0},module:{rules:[{test:/\.tsx?$/,exclude:/node_modules/,include:[i],use:{loader:"swc-loader",options:{jsc:{parser:{syntax:"typescript",jsx:!0},transform:{react:{runtime:"automatic"}}}}}},{test:/\.jsx?$/,exclude:/node_modules/,include:[i],use:{loader:"swc-loader",options:{jsc:{parser:{syntax:"ecmascript",jsx:!0},transform:{react:{runtime:"automatic"}}}}}},{test:/\.css$/,use:[J.loader,"css-loader","postcss-loader"]},{test:/\.svg$/,oneOf:[{type:"asset/resource",resourceQuery:/url/},{type:"asset/inline",resourceQuery:/base64/},{issuer:/\.[jt]sx?$/,use:["@svgr/webpack"]}],generator:{filename:`images/${c?"[name]-[hash][ext]":"[name][ext]"}`}},{test:/\.(eot|otf|ttf|woff|woff2)$/,type:"asset/resource"},{test:/\.(js|mjs)(\.map)?$/,enforce:"pre",use:["source-map-loader"]},{test:/\.m?jsx?$/,resolve:{fullySpecified:!1}}]},resolve:{alias:ne,symlinks:!1,extensions:[".js",".jsx",".ts",".tsx"],mainFields:["browser","module","main"],modules:["node_modules",ae.resolve(__dirname,"..","node_modules")],fallback:{readline:!1,path:!1}},plugins:[new Le({inject:!0,template:n||ae.resolve(__dirname,"..","ui","index.html"),publicPath:d}),new Te.DefinePlugin(p),!c&&new Ve,...f].filter(Boolean)}}a(K,"getWebpackConfig");async function P(e,t){let i=K(t),r=Me.join(e,"src","admin","webpack.config.js");if(await ze.pathExists(r)){let n;try{n=$(r)}catch(s){l.panic(`Error loading custom webpack config: ${s.message}`)}typeof n=="function"&&(t.devServer&&(i.devServer=t.devServer),i=n(i,Ue),i||l.panic("Nothing was returned from your custom webpack configuration"))}return i}a(P,"getCustomWebpackConfig");function se(e){return(t,i)=>e(t,i)}a(se,"withCustomWebpackConfig");async function ce({appDir:e,buildDir:t,plugins:i,options:r,reporting:o="fancy"}){await C({appDir:e,plugins:i});let n=B.resolve(e,".cache"),s=B.resolve(n,"admin","src","main.tsx"),c=B.resolve(e,t),d=await P(e,{entry:s,dest:c,cacheDir:n,env:"production",options:r,reporting:o}),f=Ge(d);return new Promise((E,g)=>{f.run((u,y)=>{u&&(u.details&&l.error(u.details),g(u));let S=y.toJson();return y.hasErrors()&&l.error(JSON.stringify(S.errors)),E({stats:y,warnings:S.warnings})})})}a(ce,"build");import le from"fs-extra";import fe from"node:path";async function de({appDir:e,outDir:t}){let i=fe.resolve(e,".cache","admin"),r=fe.resolve(e,t);await le.remove(r),await le.remove(i)}a(de,"clean");import pe from"node:path";import qe from"webpack";import Je from"webpack-dev-server";async function me({appDir:e,buildDir:t,plugins:i,options:r={path:"/",backend:"http://localhost:9000",develop:{open:!0,port:7001,logLevel:"error",stats:"minimal"}}}){let{cacheDir:o}=await C({appDir:e,plugins:i}),n=pe.resolve(o,"admin","src","main.tsx"),s=pe.resolve(e,t),p=await P(e,{entry:n,dest:s,cacheDir:o,env:"development",options:r}),d=qe({...p,infrastructureLogging:{level:r.develop.logLevel},stats:r.develop.stats}),f={port:r.develop.port,client:{logging:"none",overlay:{errors:!0,warnings:!1}},open:r.develop.open?{target:`http://localhost:${r.develop.port}${r.path?r.path:""}`}:!1,devMiddleware:{publicPath:r.path},historyApiFallback:{index:r.path,disableDotRule:!0}},E=new Je(f,d);await a(async()=>{l.info(`Started development server on http://localhost:${r.develop.port}${r.path?r.path:""}`),await E.start()},"runServer")(),await G(e,o,i)}a(me,"develop");export{q as ALIASED_PACKAGES,ce as build,de as clean,me as develop,F as findAllValidRoutes,A as findAllValidSettings,D as findAllValidWidgets,L as forbiddenRoutes,R as injectionZones,l as logger,v as normalizePath,se as withCustomWebpackConfig};
//# sourceMappingURL=index.mjs.map